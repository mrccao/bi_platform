{% extends "layout/app.html" %}

{% block page_title %}Reg Platform Distribution{% endblock %}

{% block head_tail %}
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/css/dataTables.bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/2.1.25/daterangepicker.min.css" rel="stylesheet">
{% endblock %}

{% block main_content %}
    <section class="content-header">
        <h1>User Source </h1>
    </section>
    <section class="content">
       <div class="row">
            <div class="col-md-12">
                <div class="box box-primary">
                    <div class="box-body">
                           <div class="row">
            <div class="col-xs-12">
                    <div class="tab-content">
                        <div class="tab-pane active" id="tab_1">
                            <div class="row">

                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Date range</label>
                                        <div class="input-group">
                                            <div class="input-group-addon">
                                                <i class="fa fa-calendar"></i>
                                            </div>
                                            <input type="text" class="form-control pull-right" id="executive-date-range">
                                        </div>
                                    </div>
                                </div>

                                <div class="col-md-2">
                                    <div class="form-group">
                                        <label>Platform</label>
                                        <select class="form-control select2" style="width: 100%;" id="executive-platform">
                                            <option selected="selected">All Platform</option>
                                            <option>Web</option>
                                            <option>iOS</option>
                                            <option>Android</option>
                                            <option>Facebook Game</option>
                                        </select>
                                    </div>
                                </div>


                                <div class="col-md-4">
                                    <div class="form-group">
                                        <div style="margin-top: 24px;">
                                            <button type="button" class="btn btn-success" id="btn-executive-apply">Apply</button>
                                        </div>
                                    </div>
                                </div>

                            </div>

                            <div class="row" >
                                <div class="col-md-12" style=" height: 20px;">
                                    <div>
                                        <canvas id="executive-chart" width="100%" height="42%"></canvas>
                                    </div>
                                </div>
                            </div>

                        </div>
                        </div>
                    </div>
                </div>

                        <div id="charts_all_platform" style="height: 400px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-md-12">
                <div class="box box-primary">

                    <div id="charts_every_platform" style="height: 740px; width: 100%;"></div>
                    <div class="box-body">

                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block body_tail %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/js/jquery.dataTables.min.js"
            type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/js/dataTables.bootstrap.min.js"
            type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.1.0/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.1.2/js/buttons.bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.1.0/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.27/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.5.2/echarts.common.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts-all-3.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.5.2/extension/dataTool.min.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>
    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/world.js"></script>
    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ZUONbpqGBsYGXNIYHicvbAbM"></script>
    <script type="text/javascript"
            src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/2.1.25/daterangepicker.min.js"></script>
    <script type="text/javascript">

        var echartsColorPalette = [
            '#c12e34', '#e6b600', '#0098d9', '#2b821d',
            '#005eaa', '#339ca8', '#cda819', '#32a487',
            '#E01F54', '#001852', '#f5e8c8', '#b8d2c7', '#c6b38e',
            '#a4d8c2', '#f3d999', '#d3758f', '#dcc392', '#2e4783',
            '#82b6e9', '#ff6347', '#a092f1', '#0a915d', '#eaf889',
            '#6699FF', '#ff6666', '#3cb371', '#d5b158', '#38b6b6'
        ];

        var echartsTheme = {
            color: echartsColorPalette,
            title: {
                textStyle: {
                    fontWeight: 'normal'
                }
            },
            visualMap: {
                color: ['#1790cf', '#a2d4e6']
            },
            toolbox: {
                iconStyle: {
                    normal: {
                        borderColor: '#06467c'
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.6)'
            },
            dataZoom: {
                dataBackgroundColor: '#dedede',
                fillerColor: 'rgba(154,217,247,0.2)',
                handleColor: '#005eaa'
            },
            timeline: {
                lineStyle: {
                    color: '#005eaa'
                },
                controlStyle: {
                    normal: {
                        color: '#005eaa',
                        borderColor: '#005eaa'
                    }
                }
            },
            candlestick: {
                itemStyle: {
                    normal: {
                        color: '#c12e34',
                        color0: '#2b821d',
                        lineStyle: {
                            width: 1,
                            color: '#c12e34',
                            color0: '#2b821d'
                        }
                    }
                }
            },

            graph: {
                color: echartsColorPalette
            },

            map: {
                label: {
                    normal: {
                        textStyle: {
                            color: '#c12e34'
                        }
                    },
                    emphasis: {
                        textStyle: {
                            color: '#c12e34'
                        }
                    }
                },
                itemStyle: {
                    normal: {
                        borderColor: '#eee',
                        areaColor: '#ddd'
                    },
                    emphasis: {
                        areaColor: '#e6b600'
                    }
                }
            },

            gauge: {
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: [[0.2, '#2b821d'], [0.8, '#005eaa'], [1, '#c12e34']],
                        width: 5
                    }
                },
                axisTick: {
                    splitNumber: 10,
                    length: 8,
                    lineStyle: {
                        color: 'auto'
                    }
                },
                axisLabel: {
                    textStyle: {
                        color: 'auto'
                    }
                },
                splitLine: {
                    length: 12,
                    lineStyle: {
                        color: 'auto'
                    }
                },
                pointer: {
                    length: '90%',
                    width: 3,
                    color: 'auto'
                },
                title: {
                    textStyle: {
                        color: '#333'
                    }
                },
                detail: {
                    textStyle: {
                        color: 'auto'
                    }
                }
            }
        };
        echarts.registerTheme('shine', echartsTheme);

        var dom = document.getElementById("charts_every_platform");
        var dom1 = document.getElementById("charts_all_platform");
        var myChart_every_platform = echarts.init(dom, 'shine');
        var myChart_all_platform = echarts.init(dom1, 'shine');

        option_all_platform = {
            tooltip: {
                trigger: 'axis'
            },
            legend: {

                data: ['email_reg', 'guest_reg', 'facebook_login_reg', 'facebook_game_reg']
            },
            toolbox: {
                    show: true,
                    feature: {
                        saveAsImage: {show: true}
                    }
                },

            grid: {
                top: '15%',
                bottom: '3%',
                left: '1%',
                right: '4%',
                containLabel: true
            },
            xAxis: {
                type: 'category',
                boundaryGap: false,
                data: []
            },
            yAxis: {
                type: 'value',
                max: 1000
            },
            series: []
        };


        option_every_platform = {
            baseOption: {
                timeline: {
                    axisType: 'category',
                    autoPlay: true,
                    realtime: true,
                    playInterval: 2000,
                    label: {
                        formatter: function (s) {
                            return s
                        }
                    },
                    loop: true
                },
                tooltip: {
                    formatter: "{a}{b}{c}{d}"
                },
                legend: {
                    top: '3%',
                    left: '45%',
                    data: ['email_reg', 'guest_reg', 'facebook_login_reg', 'facebook_game_reg']
                },
                calculable: true,
                toolbox: {
                    show: true,
                    feature: {
                        saveAsImage: {show: true}
                    }
                },

                grid: {
                    top: 99,
                    bottom: 100
                },
                xAxis: [
                    {
                        'type': 'category',
                        'axisLabel': {'interval': 0},
                        'data': ["iOS", "Android", "Web", "Web Mobile", "Facebook Game"]
                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        max: 1500
                    }
                ],
                series: [
                    {name: 'email_reg', type: 'bar'},
                    {name: 'guest_reg', type: 'bar'},
                    {name: 'facebook_login_reg', type: 'bar'},
                    {name: 'facebook_game_reg', type: 'bar'},
                    {

                        type: 'pie',
                        center: ['73%', '25%'],
                        radius: '18%'

                    },

                    {
                        type: 'pie',
                        center: ['73%', '53%'],
                        radius: '18%'
                    }

                ]
            }


        };


        window.onresize = myChart_every_platform.resize;
        window.onresize = myChart_all_platform.resize;

        $(function () {


            $(".select2").select2();

            $('#executive-date-range').daterangepicker({
                opens: 'right',
                showDropdowns: true,
                autoApply: true,
                locale: {
                    format: 'YYYY-MM-DD',
                    separator: '  -  '
                },
                ranges: {
                    // 'Today': [moment(), moment()],
                    // 'Yesterday': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                    'Last 7 Days': [moment().subtract(6, 'days'), moment()],
                    'Last 30 Days': [moment().subtract(29, 'days'), moment()],
                    'This Week': [moment().startOf('week'), moment().endOf('week')],
                    'Last Week': [moment().subtract(1, 'week').startOf('week'), moment().subtract(1, 'week').endOf('week')],
                    'This Month': [moment().startOf('month'), moment().endOf('month')],
                    'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')]
                },
                startDate: moment().subtract(60, 'days'),
                endDate: moment(),
                minDate: moment().subtract(6, 'month'),
                maxDate: moment()
            });

            var resultDataTable = null;

            $.ajax({
                type: 'GET',
                url: '/report/reg_platform_data',
                dataType: "json",

                success: function (result) {


                    var options = [];

                    var email_reg_all_platform_all_days = [];
                    var guest_reg_all_platform_all_days = [];
                    var facebook_login_reg_all_platform_all_days = [];
                    var facebook_game_reg_all_platform_all_days = [];

                    for (var i in  result.day_range) {

                        var day = result.day_range[i];

                        var email_reg = result.email_reg[day].slice(0, 5);
                        var guest_reg = result.guest_reg[day].slice(0, 5);
                        var facebook_login_reg = result.facebook_login_reg[day].slice(0, 5);
                        var facebook_game_reg = result.facebook_game_reg[day].slice(0, 5);

                        var users_count_every_platform = {};
                        users_count_every_platform['iOS'] = email_reg[0] + guest_reg[0] + facebook_login_reg[0] + facebook_game_reg[0];
                        users_count_every_platform['Android'] = email_reg[1] + guest_reg[1] + facebook_login_reg[1] + facebook_game_reg[1];
                        users_count_every_platform['Web'] = email_reg[2] + guest_reg[2] + facebook_login_reg[2] + facebook_game_reg[2];
                        users_count_every_platform['Facebook Game'] = email_reg[4] + guest_reg[4] + facebook_login_reg[4] + facebook_game_reg[4];

                        email_reg_all_platform_all_days.push(result.email_reg[day][5]);
                        guest_reg_all_platform_all_days.push(result.guest_reg[day][5]);
                        facebook_login_reg_all_platform_all_days.push(result.facebook_login_reg[day][5]);
                        facebook_game_reg_all_platform_all_days.push(result.facebook_game_reg[day][5]);


                        options.push(
                            {
                                title: {
                                    text: day,
                                    left: 30,
                                    top: 20
                                },
                                series: [
                                    {data: result.email_reg[day].slice(0, 5)},
                                    {data: result.guest_reg[day].slice(0, 5)},
                                    {data: result.facebook_login_reg[day].slice(0, 5)},
                                    {data: result.facebook_game_reg[day].slice(0, 5)},
                                    {
                                        data: [{name: 'email_reg', value: result.email_reg[day][5]},
                                            {name: 'guest_reg', value: result.guest_reg[day][5]},
                                            {name: 'facebook_login_reg', value: result.facebook_login_reg[day][5]},
                                            {name: 'facebook_game_reg', value: result.facebook_game_reg[day][5]}
                                        ]
                                    },
                                    {
                                        data: [{
                                            name: 'iOS', value: users_count_every_platform['iOS']
                                        },
                                            {name: 'Android', value: users_count_every_platform['Android']},
                                            {name: 'Web', value: users_count_every_platform['Web']},
                                            {name: 'Facebook Game', value: users_count_every_platform['Facebook Game']},
                                        ]
                                    }

                                ]
                            }
                        );

                    }
                    option_all_platform.series = [{

                        name: 'email_reg',
                        type: 'line',
                        smooth: true,
                        data: email_reg_all_platform_all_days


                    },
                        {
                            name: 'guest_reg',
                            type: 'line',
                            smooth: true,
                            data: guest_reg_all_platform_all_days


                        }, {
                            name: 'facebook_login_reg',
                            type: 'line',
                            smooth: true,
                            data: facebook_login_reg


                        }, {
                            name: 'facebook_game_reg',
                            type: 'line',
                            smooth: true,
                            data: facebook_game_reg


                        }


                    ]
                    ;


                    option_all_platform.xAxis.data = result.day_range;


                    option_every_platform.baseOption.timeline.data = result.day_range;
                    option_every_platform.options = options;
                    ////////////////////
                    myChart_every_platform.setOption(option_every_platform, true);
                    myChart_all_platform.setOption(option_all_platform, true);
                }
            })
            ;
        })
        ;
    </script>
{% endblock %}