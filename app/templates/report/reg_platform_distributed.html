{% extends "layout/app.html" %}

{% block page_title %}Reg Platform Distribution{% endblock %}

{% block head_tail %}
    <link rel="stylesheet"
          href="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/css/dataTables.bootstrap.min.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/bootstrap-daterangepicker/2.1.25/daterangepicker.min.css"
          rel="stylesheet">
{% endblock %}

{% block main_content %}
    <section class="content-header">
        <h1>User Source </h1>
    </section>
    <section class="content">
        <div class="row">


            {#                        <div class="col-md-2" style="float: right">#}
            {#                            <div class="form-group">#}
            {#                                <select class="form-control select2" style="width: 100%;" id="executive-platform">#}
            {#                                    <option selected="selected">All Platform</option>#}
            {#                                    <option>Web</option>#}
            {#                                    <option>iOS</option>#}
            {#                                    <option>Android</option>#}
            {#                                    <option>Facebook Game</option>#}
            {#                                </select>#}
            {#                            </div>#}
            {#                        </div>#}

            <div class="col-md-12">


                <div class="box box-primary" style="margin-bottom: 0; ">

                    <div class="box-body">

                        <div class="col-md-8">


                            <div id="chart2" style="height: 420px; width: 100%;"></div>

                        </div>

                        <div class="col-md-4">
                            <div id="chart2_platform" style="height: 219px; width: 100%;"></div>
                            <div id="chart2_reg_method" style="height: 219px; width: 100%;"></div>


                        </div>
                    </div>

                </div>

                <div class="row">
                    <div class="col-md-12">


                        <div class="box box-primary" style="border-top-width: 0;margin-bottom: 0; ">

                            <div class="box-body">

                                <div class="col-md-8">


                                    <div id="chart1" style="height: 420px; width: 100%;"></div>

                                </div>

                                <div class="col-md-4">
                                    <div id="chart1_platform" style="height: 219px; width: 100%;"></div>
                                    <div id="chart1_reg_method" style="height: 219px; width: 100%;"></div>


                                </div>
                            </div>
                        </div>

                    </div>


                </div>


            </div>


            <div class="row" style="display: ">
                <div class="col-md-12">
                    <div class="box box-primary" style="border-top-width: 0; ">

                        <div class="box-body">

                            <div id="chart3" style="height: 420px; width: 100%;"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>
{% endblock %}

{% block body_tail %}

    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/js/jquery.dataTables.min.js"
            type="text/javascript"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/datatables/1.10.13/js/dataTables.bootstrap.min.js"
            type="text/javascript"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.1.0/js/dataTables.buttons.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.1.2/js/buttons.bootstrap.min.js"></script>
    <script type="text/javascript" src="https://cdn.datatables.net/buttons/1.1.0/js/buttons.html5.min.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/pdfmake/0.1.27/pdfmake.min.js"></script>
    <script type="text/javascript" src="https://cdn.rawgit.com/bpampuch/pdfmake/0.1.18/build/vfs_fonts.js"></script>
    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jszip/2.5.0/jszip.min.js"></script>


    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.5.2/echarts.common.min.js"></script>

    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/echarts-all-3.js"></script>

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.5.2/extension/dataTool.min.js"></script>

    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/china.js"></script>

    <script type="text/javascript" src="http://echarts.baidu.com/gallery/vendors/echarts/map/js/world.js"></script>

    <script type="text/javascript" src="http://api.map.baidu.com/api?v=2.0&ak=ZUONbpqGBsYGXNIYHicvbAbM"></script>

    <script type="text/javascript"
            src="http://echarts.baidu.com/gallery/vendors/echarts/extension/bmap.min.js"></script>
    <script type="text/javascript">

        var echartsColorPalette = [
            '#c12e34', '#e6b600', '#0098d9', '#2b821d',
            '#005eaa', '#339ca8', '#cda819', '#32a487',
            '#E01F54', '#001852', '#f5e8c8', '#b8d2c7', '#c6b38e',
        ];

        var echartsTheme = {
            color: echartsColorPalette,
            title: {
                textStyle: {
                    fontWeight: 'normal'
                }
            },
            visualMap: {
                color: ['#1790cf', '#a2d4e6']
            },
            toolbox: {
                iconStyle: {
                    normal: {
                        borderColor: '#06467c'
                    }
                }
            },
            tooltip: {
                backgroundColor: 'rgba(0,0,0,0.6)'
            },
            dataZoom: {
                dataBackgroundColor: '#dedede',
                fillerColor: 'rgba(154,217,247,0.2)',
                handleColor: '#005eaa'
            },
            timeline: {
                lineStyle: {
                    color: '#005eaa'
                },
                controlStyle: {
                    normal: {
                        color: '#005eaa',
                        borderColor: '#005eaa'
                    }
                }
            },
            candlestick: {
                itemStyle: {
                    normal: {
                        color: '#c12e34',
                        color0: '#2b821d',
                        lineStyle: {
                            width: 1,
                            color: '#c12e34',
                            color0: '#2b821d'
                        }
                    }
                }
            },

            graph: {
                color: echartsColorPalette
            },

            map: {
                label: {
                    normal: {
                        textStyle: {
                            color: '#c12e34'
                        }
                    },
                    emphasis: {
                        textStyle: {
                            color: '#c12e34'
                        }
                    }
                },
                itemStyle: {
                    normal: {
                        borderColor: '#eee',
                        areaColor: '#ddd'
                    },
                    emphasis: {
                        areaColor: '#e6b600'
                    }
                }
            },

            gauge: {
                axisLine: {
                    show: true,
                    lineStyle: {
                        color: [[0.2, '#2b821d'], [0.8, '#005eaa'], [1, '#c12e34']],
                        width: 5
                    }
                },
                axisTick: {
                    splitNumber: 10,
                    length: 8,
                    lineStyle: {
                        color: 'auto'
                    }
                },
                axisLabel: {
                    textStyle: {
                        color: 'auto'
                    }
                },
                splitLine: {
                    length: 12,
                    lineStyle: {
                        color: 'auto'
                    }
                },
                pointer: {
                    length: '90%',
                    width: 3,
                    color: 'auto'
                },
                title: {
                    textStyle: {
                        color: '#333'
                    }
                },
                detail: {
                    textStyle: {
                        color: 'auto'
                    }
                }
            }
        };

        echarts.registerTheme('shine', echartsTheme);

        var dom1 = document.getElementById("chart1");
        var dom4 = document.getElementById("chart1_platform");
        var dom5 = document.getElementById("chart1_reg_method");
        var dom2 = document.getElementById("chart2");
        var dom6 = document.getElementById("chart2_platform");
        var dom7 = document.getElementById("chart2_reg_method");
        var dom3 = document.getElementById("chart3");


        var myChart1 = echarts.init(dom1, 'shine');
        var myChart2 = echarts.init(dom2, 'shine');
        var myChart3 = echarts.init(dom3, 'shine');
        var myChart4 = echarts.init(dom4, 'shine');
        var myChart5 = echarts.init(dom5, 'shine');
        var myChart6 = echarts.init(dom6, 'shine');
        var myChart7 = echarts.init(dom7, 'shine');


        chart1_platform_option = {
            title: {
                {#                text: 'This Month Platform Distribution',#}
                x: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: "----------------------------------------------{a} <br/>{b} : {c} ({d}%)"
            },
            legend: {
                orient: 'vertical',
                left: 'left',
                {#                data: ['iOS', 'Android', 'Web', 'Facebook Game']#}
            },
            series: [
                {
                    type: 'pie',
                    radius: '55%',
                    center: ['50%', '60%'],
                    data: [],
                    itemStyle: {
                        emphasis: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };
        chart1_reg_method_option = {
            title: {
                {#                text: 'This Month User Source Distribution',#}
                x: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: "------------------------------------------------{a} <br/>{b} : {c} ({d}%)"
            },
            legend: {
                orient: 'vertical',
                left: 'left',
                {#                data: ['email_reg', 'guest_reg', 'facebook_login_reg', 'facebook_game_reg']#}
            },
            series: [
                {
                    type: 'pie',
                    radius: '55%',
                    center: ['50%', '60%'],
                    data: [],
                    itemStyle: {
                        emphasis: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };
        chart2_platform_option = {
            title: {
                {#                text: 'Last Month User Source Distribution',#}
                x: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: "-------------------------------------------------{a} <br/>{b} : {c} ({d}%)"
            },
            legend: {
                orient: 'vertical',
                left: 'left',
                {#                data: ['iOS', 'Android', 'Web', 'Facebook Game']#}
            },
            series: [
                {
                    type: 'pie',
                    radius: '55%',
                    center: ['50%', '60%'],
                    data: [],
                    itemStyle: {
                        emphasis: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };
        chart2_reg_method_option = {
            title: {
                {#                text: 'Last Month Platform Distribution',#}
                x: 'center'
            },
            tooltip: {
                trigger: 'item',
                formatter: "-----------------------------------------------{a} <br/>{b} : {c} ({d}%)"
            },
            legend: {
                orient: 'vertical',
                left: 'left',
                {#                data: ['email_reg', 'guest_reg', 'facebook_login_reg', 'facebook_game_reg']#}
            },
            series: [
                {
                    type: 'pie',
                    radius: '55%',
                    center: ['50%', '60%'],
                    data: [],
                    itemStyle: {
                        emphasis: {
                            shadowBlur: 10,
                            shadowOffsetX: 0,
                            shadowColor: 'rgba(0, 0, 0, 0.5)'
                        }
                    }
                }
            ]
        };
        chart1_option = {
            tooltip: {
                trigger: 'axis'
            },

            title: {
                text: 'Last Month'

            },
            legend: {


                selected: {'email_reg': 1, 'guest_reg': 0, 'facebook_login_reg': 0, 'facebook_game_reg': 0},
                data: []
            },

            grid: {
                top: '15%',
                bottom: '3%',
                left: '1%',
                right: '4%',
                containLabel: true
            },
            xAxis: {type: 'category', boundaryGap: false, data: []}
            ,
            yAxis: {
                type: 'value',
                max: 1000
            },
            series: []

        };
        chart2_option = {
            tooltip: {
                trigger: 'axis'
            },
            legend: {
                data: ['email_reg', 'guest_reg', 'facebook_login_reg', 'facebook_game_reg'],

                selected: {'email_reg': 1, 'guest_reg': 0, 'facebook_login_reg': 0, 'facebook_game_reg': 0}
            },

            title: {
                text: 'This Month'

            },
            {#            toolbox: {#}
            {#                show: true,#}
            {#                feature: {#}
            {#                    saveAsImage: {show: true}#}
            {#                }#}
            {#            },#}
            markPoint: {
                data: [
                    {type: 'max', name: '最大值'},
                    {type: 'min', name: '最小值'}
                ]
            },
            markLine: {
                data: [
                    {type: 'average', name: '平均值'}
                ]
            },
            grid: {
                top: '15%',
                bottom: '3%',
                left: '1%',
                right: '4%',
                containLabel: true
            },
            xAxis: {
                type: 'category', boundaryGap: false, data: []
            }
            ,
            yAxis: {
                type: 'value',
                max: 1000
            },
            series: []
        };
        chart3_option = {
            baseOption: {
                timeline: {
                    axisType: 'category',
                    autoPlay: true,
                    realtime: true,
                    playInterval: 2000,
                    label: {
                        formatter: function (s) {
                            return s
                        }
                    },
                    loop: true
                },
                legend: {
                    top: '3%',
                    left: '33%',
                    data: ['email_reg', 'guest_reg', 'facebook_login_reg', 'facebook_game_reg']
                },
                calculable: true,

                grid: {
                    top: 99,
                    bottom: 100
                },
                xAxis: [
                    {
                        'type': 'category',
                        'axisLabel': {'interval': 0},
                        'data': ["iOS", "Android", "Web", "Facebook Game"]

                    }
                ],
                yAxis: [
                    {
                        type: 'value',
                        max: 1500
                    }
                ],
                series: [
                    {name: 'email_reg', type: 'bar'},
                    {name: 'guest_reg', type: 'bar'},
                    {name: 'facebook_login_reg', type: 'bar'},
                    {name: 'facebook_game_reg', type: 'bar'},
                    {

                        type: 'pie',
                        center: ['82%', '25%'],
                        radius: '20%'

                    },

                    {
                        type: 'pie',
                        center: ['82%', '53%'],
                        radius: '20%'
                    }

                ]
            }


        };


        $(function () {


            $(".select2").select2();
            $.ajax({
                type: 'GET',
                url: '/report/reg_platform_data',
                dataType: "json",

                success: function (result) {


                    var options = [];


                    for (var i in  result.day_range) {

                        var day = result.day_range[i];

                        var email_reg = result.email_reg[day].slice(0, 4);
                        var guest_reg = result.guest_reg[day].slice(0, 4);
                        var facebook_login_reg = result.facebook_login_reg[day].slice(0, 4);
                        var facebook_game_reg = result.facebook_game_reg[day].slice(0, 4);

                        var users_count_every_platform = {};
                        users_count_every_platform['iOS'] = email_reg[0] + guest_reg[0] + facebook_login_reg[0] + facebook_game_reg[0];
                        users_count_every_platform['Android'] = email_reg[1] + guest_reg[1] + facebook_login_reg[1] + facebook_game_reg[1];
                        users_count_every_platform['Web'] = email_reg[2] + guest_reg[2] + facebook_login_reg[2] + facebook_game_reg[2];
                        users_count_every_platform['Facebook Game'] = email_reg[4] + guest_reg[4] + facebook_login_reg[4] + facebook_game_reg[4];


                        options.push(
                            {
                                title: {
                                    text: day,
                                    left: 30,
                                    top: 20
                                },
                                series: [
                                    {data: result.email_reg[day].slice(0, 4)},
                                    {data: result.guest_reg[day].slice(0, 4)},
                                    {data: result.facebook_login_reg[day].slice(0, 4)},
                                    {data: result.facebook_game_reg[day].slice(0, 4)},
                                    {
                                        data: [{name: 'email_reg', value: result.email_reg[day][4]},
                                            {name: 'guest_reg', value: result.guest_reg[day][4]},
                                            {name: 'facebook_login_reg', value: result.facebook_login_reg[day][4]},
                                            {name: 'facebook_game_reg', value: result.facebook_game_reg[day][4]}
                                        ]
                                    },
                                    {
                                        data: [{
                                            name: 'iOS', value: users_count_every_platform['iOS']
                                        },
                                            {name: 'Android', value: users_count_every_platform['Android']},
                                            {name: 'Web', value: users_count_every_platform['Web']},
                                            {name: 'Facebook Game', value: users_count_every_platform['Facebook Game']},
                                        ]
                                    }


                                ]
                            }
                        );

                    }


                    chart3_option.baseOption.timeline.data = result.day_range;
                    chart3_option.options = options;
                    myChart3.setOption(chart3_option, true);


                }
            });


            $.ajax({
                type: 'GET',
                url: '/report/user_reg_data',
                dataType: "json",

                success: function (result) {


                    chart2_option.series = [

                        {

                            markPoint: {
                                data: [
                                    {type: 'max', name: '最大值'},
                                    {type: 'min', name: '最小值'}
                                ]
                            },

                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            },
                            name: 'email_reg',
                            type: 'line',
                            smooth: true,
                            data: result.current_month_data[0]


                        },
                        {
                            markPoint: {
                                data: [
                                    {type: 'max', name: '最大值'},
                                    {type: 'min', name: '最小值'}
                                ]
                            },

                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            },
                            name: 'guest_reg',
                            type: 'line',
                            smooth: true,

                            data: result.current_month_data[1]


                        }, {

                            markPoint: {
                                data: [
                                    {type: 'max', name: '最大值'},
                                    {type: 'min', name: '最小值'}
                                ]
                            },

                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            },
                            name: 'facebook_login_reg',
                            type: 'line',
                            smooth: true,
                            data: result.current_month_data[2]


                        }, {

                            markPoint: {
                                data: [
                                    {type: 'max', name: '最大值'},
                                    {type: 'min', name: '最小值'}
                                ]
                            },

                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            },
                            name: 'facebook_game_reg',
                            type: 'line',
                            smooth: true,
                            data: result.current_month_data[3]


                        }


                    ];
                    chart1_option.series = [

                        {

                            markPoint: {
                                data: [
                                    {type: 'max', name: '最大值'},
                                    {type: 'min', name: '最小值'}
                                ]
                            },

                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            },
                            name: 'email_reg',
                            type: 'line',
                            smooth: true,
                            data: result.previous_month_data[0]


                        },
                        {
                            markPoint: {
                                data: [
                                    {type: 'max', name: '最大值'},
                                    {type: 'min', name: '最小值'}
                                ]
                            },

                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            },
                            name: 'guest_reg',
                            type: 'line',
                            smooth: true,

                            data: result.previous_month_data[1]


                        }, {

                            markPoint: {
                                data: [
                                    {type: 'max', name: '最大值'},
                                    {type: 'min', name: '最小值'}
                                ]
                            },

                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            },
                            name: 'facebook_login_reg',
                            type: 'line',
                            smooth: true,
                            data: result.previous_month_data[2]


                        }, {

                            markPoint: {
                                data: [
                                    {type: 'max', name: '最大值'},
                                    {type: 'min', name: '最小值'}
                                ]
                            },

                            markLine: {
                                data: [
                                    {type: 'average', name: '平均值'}
                                ]
                            },
                            name: 'facebook_game_reg',
                            type: 'line',
                            smooth: true,
                            data: result.previous_month_data[3]

                        }


                    ];


                    chart1_platform_option.series[0].data = result.previous_each_platform_reg_count_proxy;
                    chart1_reg_method_option.series[0].data = result.previous_each_reg_method_count_proxy;


                    chart2_platform_option.series[0].data = result.current_month_each_platform_reg_count_proxy;

                    chart2_reg_method_option.series[0].data = result.current_month_each_reg_method_count_proxy;


                    chart1_option.xAxis.data = result.previous_month_day_range;
                    chart2_option.xAxis.data = result.current_month_day_range;

                    myChart1.setOption(chart1_option, true);
                    myChart2.setOption(chart2_option, true);


                    myChart4.setOption(chart1_platform_option, true);
                    myChart5.setOption(chart1_reg_method_option, true);


                    myChart6.setOption(chart2_platform_option, true);
                    myChart7.setOption(chart2_reg_method_option, true);


                    echarts.connect([myChart1, myChart2]);


                }
            });


            window.onresize = myChart1.resize;
            window.onresize = myChart2.resize;
            window.onresize = myChart3.resize;

        });


    </script>
{% endblock %}