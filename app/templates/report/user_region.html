{% extends "layout/app.html" %}
{% block page_title %}New User{% endblock %}
{% block head_tail %}


    <style>


    </style>

{% endblock %}

{% block main_content %}
    <section class="content-header">
        <h1>User Region</h1>
    </section>

    <section class="content">
        <div class="row">
            <div class="col-md-12">

                <div class="box box-primary">
                    <div class="box-header with-border">
                        <h3 class="box-title"> User Region by State</h3>
                        <div class="btn-group" style="float: right">
                            <button id="daily" type="button" class="btn btn-default">Daily</button>
                            <button id="monthly" type="button" class="btn btn-default">Monthly</button>
                            <button id="lifetime" type="button" class="btn btn-default">Lifetime</button>
                        </div>

                    </div>
                    <div class="box-body">

                        <div id="container-America" style="height: 690px; width: 100%;"></div>
                    </div>
                </div>
            </div>
        </div>


    </section>
{% endblock %}
{% block body_tail %}



    <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.5.4/echarts.min.js"></script>
    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.5.2/extension/dataTool.min.js"></script>

    {% assets "flask_AmericaGeojson_js" %}
        <script src="{{ ASSET_URL }}" type="text/javascript"></script>
    {% endassets %}
    {##}
    {#    {% assets "flask_WorldGeojson_js" %}#}
    {#        <script src="{{ ASSET_URL }}" type="text/javascript"></script>#}
    {#    {% endassets %}#}

    <script type="text/javascript"
            src="https://cdnjs.cloudflare.com/ajax/libs/echarts/3.5.4/extension/bmap.min.js"></script>

    <script>


        var dom1 = document.getElementById("container-America");

        var myChart_America = echarts.init(dom1);


        var option_America = {
            baseOption: {
                timeline: {
                    axisType: 'category',
                    bottom: -5,
                    playInterval: 5000,
                    data: []
                },
                title: {
                    left: 'middle'
                },
                tooltip: {
                    trigger: 'item',
                    formatter: function (params) {
                        var value = (params.value + '').split('.');
                        value = value[0].replace(/(\d{1,3})(?=(?:\d{3})+(?!\d))/g, '$1,')
                            + '.' + value[1];
                        return params.seriesName + '<br/>' + params.name + ' : ' + value;
                    }
                },
                toolbox: {

                    show: true,
                    orient: 'vertical',
                    left: 'right',
                    top: '68%',
                    feature: {
                        mark: {show: true},
                        restore: {title: 'Reset'}
                    }
                },
                grid: {
                    left: '0%',
                    right: '83%',
                    bottom: '35%',
                    top: '91%',
                    containLabel: true,

                },
                xAxis: [{
                    position: 'top',
                    type: 'value',
                    boundaryGap: false,
                    splitLine: {
                        show: false
                    },
                    axisLine: {
                        show: false
                    },
                    axisTick: {
                        show: false
                    }
                }],

                yAxis: {

                    axisLabel: {
                        interval: 0,
                    },
                    max: 'dataMax'
                },

                series: [{
                    name: 'User Region by State', type: 'map', mapType: 'USA',
                    roam: true,
                    itemStyle: {
                        emphasis: {label: {show: true}}
                    },

                    data: []

                },

                    {
                        z: 2,
                        type: 'bar', label: {
                        normal: {show: true},
                        emphasis: {
                            show: true
                        }
                    },
                        itemStyle: {
                            emphasis: {}
                        },

                        data: []


                    }]
            }, options: []
        };


        $(document).ready(function () {

            $(".select2").select2();


            function getUserRegionData(group) {
                $.ajax({
                    type: 'GET',
                    url: '/report/reg_user_state',
                    data: {
                        group: group
                    },
                    dataType: "json",
                    success: function (result) {
                        if (result.type === 'lifetime') {

                            option_America.baseOption.timeline.data = '';
                            option_America.options = [
                                {
                                    yAxis: {
                                        type: 'category',
                                        data: result.bar_result.location

                                    },
                                    visualMap: {
                                        type: 'continuous',
                                        min: 0,
                                        max: 25000,
                                        text: ['High', 'Low'],
                                        left: 'right',
                                        top: 'center',
                                        realtime: false,
                                        calculable: true,
                                        inRange: {color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']}
                                    },
                                    series: [{data: result.map_result}, {data: result.bar_result.reg_count}]
                                }]
                        }
                        else {
                            var time_range = result.time_range;
                            option_America.baseOption.timeline.data = time_range;
                            var options = [];

                            for (var index in time_range) {

                                var time = time_range[index];
                                var bar_result = result.bar_result[index];



                                var location = bar_result[time].location;
                                var reg_count = bar_result[time].reg_count;
                                var max = bar_result[time].reg_count[reg_count.length-1];
                                var map_result = result.map_result[index][time];

                                options.push(
                                    {
                                        yAxis: {
                                            type: 'category',
                                            data: location

                                        },
                                        visualMap: {
                                            type: 'continuous',
                                            min: 0,
                                            max: max,
                                            text: ['High', 'Low'],
                                            left: 'right',
                                            top: 'center',
                                            realtime: false,
                                            calculable: true,
                                            inRange: {color: ['#313695', '#4575b4', '#74add1', '#abd9e9', '#e0f3f8', '#ffffbf', '#fee090', '#fdae61', '#f46d43', '#d73027', '#a50026']}
                                        },
                                        series: [{data: map_result}, {data: reg_count}]
                                    })
                            }

                            option_America.options = options;
                        }

                        myChart_America.setOption(option_America, true);
                    }
                })
            }

            $('#daily').click(function () {
                getUserRegionData($(this).text())
            });

            $('#monthly').click(function () {
                getUserRegionData($(this).text())
            });

            $('#lifetime').click(function () {
                getUserRegionData($(this).text())
            });

            $('#daily').trigger('click');
        });


    </script>
{% endblock %}




