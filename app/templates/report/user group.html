{% extends "layout/app.html" %}
{% block page_title %}User Clustering{% endblock %}
{% block head_tail %}

    <link href="http://querybuilder.js.org/dist/bootstrap-datepicker/dist/css/bootstrap-datepicker3.min.css"
          rel="stylesheet">
    <link href="http://querybuilder.js.org/dist/seiyria-bootstrap-slider/dist/css/bootstrap-slider.min.css"
          rel="stylesheet">
    <link href="http://querybuilder.js.org/dist/selectize/dist/css/selectize.bootstrap3.css" rel="stylesheet">
    <link href="http://querybuilder.js.org/dist/bootstrap-select/dist/css/bootstrap-select.min.css" rel="stylesheet">
    <link href="http://querybuilder.js.org/dist/awesome-bootstrap-checkbox/awesome-bootstrap-checkbox.css"
          rel="stylesheet">
    <link href="http://querybuilder.js.org/dist/jQuery-QueryBuilder/dist/css/query-builder.default.min.css"
          rel="stylesheet">
    <script src="https://code.jquery.com/jquery-1.11.2.min.js"></script>
    <script src="https://netdna.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>

    <style>

        .left {
            align-self: center;
        }

        .query-builder .rules-group-container {
            padding: 10px 10px 6px;
            background: rgb(255, 255, 255);

            border: 1px solid #d2d4d4;

        }

        .condition-relation-line {
            background: -webkit-gradient(linear, left bottom, left top, color-stop(100%, #d2d4d4), to(#d2d4d4));
            background: linear-gradient(0, #d2d4d4 100%, #d2d4d4 100%);
            background-size: 3px;
            background-repeat: repeat-y;
            background-position-x: 45px;
        }


    </style>

{% endblock %}


{% block main_content %}
    <section class="content-header">
        <h1>User Clustering</h1>
    </section>
    <section class="content">


        <div class="box box-primary">
            <div class="box-body ">
                    <span style="font-size: 20px; font-weight: 600">

        Select Criteria To Filter Users

                    </span>

                <div class="row condition-relation-line">

                    <div class="col-md-12" style="float: right">

                        <div class="row">
                            <div class="col-md-12 col-lg-10 col-lg-offset-1">
                                <h2 class="box-title" style="font-size: 20px">Basic Property</h2>
                                <div id="builder-widgets"></div>

                            </div>
                        </div>

                        <div class="left">
                            <label class="btn btn-xs btn-primary active"> <input type="radio"
                                                                                 name="builder-widgets_group_0_cond"
                                                                                 value="AND"> AND </label>
                        </div>

                        <div class="row">

                        </div>
                        <div class="row">

                            <div class="col-md-12 col-lg-10 col-lg-offset-1">


                                <h2 class="box-title" style="font-size: 20px">Game Behaviour </h2>
                                <div id="builder1"></div>

                            </div>
                        </div>
                        <div class="left">
                            <label class="btn btn-xs btn-primary active"> <input type="radio"
                                                                                 name="builder-widgets_group_0_cond"
                                                                                 value="AND"> AND </label>
                        </div>
                        <div class="row">


                            <div class="col-md-12 col-lg-10 col-lg-offset-1">


                                <h2 class="box-title" style="font-size: 20px"> Consumer Behaviour </h2>
                                <div id="builder2"></div>

                            </div>

                        </div>

                        <div class="left">
                            <label class="btn btn-xs btn-primary active"> <input type="radio"
                                                                                 name="builder-widgets_group_0_cond"
                                                                                 value="AND"> AND </label>
                        </div>

                        <div style="margin-top: 130px;">
                            <button type="button" class="btn btn-success" id="btn-executive-apply">Apply
                            </button>
                        </div>

                    </div>
                </div>
            </div>
        </div>


    </section>


{% endblock %}




{% block body_tail %}

    <script src="http://querybuilder.js.org/dist/moment/min/moment.min.js"></script>
    <script src="http://querybuilder.js.org/dist/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
    <script src="http://querybuilder.js.org/dist/seiyria-bootstrap-slider/dist/bootstrap-slider.min.js"></script>
    <script src="http://querybuilder.js.org/dist/selectize/dist/js/standalone/selectize.min.js"></script>
    <script src="http://querybuilder.js.org/dist/jQuery-QueryBuilder/dist/js/query-builder.standalone.min.js"></script>
    <script src="http://querybuilder.js.org/dist/interact/dist/interact.min.js"></script>



    <script>

        var rules_widgets = {
            condition: 'OR',
            rules: [{
                id: 'date',
                operator: 'equal',
                value: '1991/11/17'
            }, {
                id: 'rate',
                operator: 'equal',
                value: 22
            }, {
                id: 'category',
                operator: 'equal',
                value: '38'
            }, {
                condition: 'AND',
                rules: [{
                    id: 'coord',
                    operator: 'equal',
                    value: 'B.3'
                }]
            }]
        };

        // Fix for Selectize
        $('#builder-widgets').on('afterCreateRuleInput.queryBuilder', function (e, rule) {
            if (rule.filter.plugin == 'selectize') {
                rule.$el.find('.rule-value-container').css('min-width', '200px')
                    .find('.selectize-control').removeClass('form-control');
            }
        });


        $('#builder-widgets').queryBuilder({
            plugins: ['bt-tooltip-errors'],

            filters: [{
                id: 'date',
                label: 'Datepicker',
                type: 'date',
                validation: {
                    format: 'YYYY/MM/DD'
                },
                plugin: 'datepicker',
                plugin_config: {
                    format: 'yyyy/mm/dd',
                    todayBtn: 'linked',
                    todayHighlight: true,
                    autoclose: true
                }
            }, {
                id: 'rate',
                label: 'Slider',
                type: 'integer',
                validation: {
                    min: 0,
                    max: 100
                },
                plugin: 'slider',
                plugin_config: {
                    min: 0,
                    max: 100,
                    value: 0
                },
                valueSetter: function (rule, value) {
                    if (rule.operator.nb_inputs == 1) value = [value];
                    rule.$el.find('.rule-value-container input').each(function (i) {
                        $(this).slider('setValue', value[i] || 0);
                    });
                },
                valueGetter: function (rule) {
                    var value = [];
                    rule.$el.find('.rule-value-container input').each(function () {
                        value.push($(this).slider('getValue'));
                    });
                    return rule.operator.nb_inputs == 1 ? value[0] : value;
                }
            }, {
                id: 'category',
                label: 'Selectize',
                type: 'string',
                plugin: 'selectize',
                plugin_config: {
                    valueField: 'id',
                    labelField: 'name',
                    searchField: 'name',
                    sortField: 'name',
                    create: true,
                    maxItems: 1,
                    plugins: ['remove_button'],
                    onInitialize: function () {
                        var that = this;

                        if (localStorage.demoData === undefined) {
                            $.getJSON(baseurl + '/assets/demo-data.json', function (data) {
                                localStorage.demoData = JSON.stringify(data);
                                data.forEach(function (item) {
                                    that.addOption(item);
                                });
                            });
                        }
                        else {
                            JSON.parse(localStorage.demoData).forEach(function (item) {
                                that.addOption(item);
                            });
                        }
                    }
                },
                valueSetter: function (rule, value) {
                    rule.$el.find('.rule-value-container input')[0].selectize.setValue(value);
                }
            }, {
                id: 'coord',
                label: 'Coordinates',
                type: 'string',
                validation: {
                    format: /^[A-C]{1}.[1-6]{1}$/
                },
                input: function (rule, name) {
                    var $container = rule.$el.find('.rule-value-container');

                    $container.on('change', '[name=' + name + '_1]', function () {
                        var h = '';

                        switch ($(this).val()) {
                            case 'A':
                                h = '<option value="-1">-</option> <option value="1">1</option> <option value="2">2</option>';
                                break;
                            case 'B':
                                h = '<option value="-1">-</option> <option value="3">3</option> <option value="4">4</option>';
                                break;
                            case 'C':
                                h = '<option value="-1">-</option> <option value="5">5</option> <option value="6">6</option>';
                                break;
                        }

                        $container.find('[name$=_2]')
                            .html(h).toggle(!!h)
                            .val('-1').trigger('change');
                    });

                    return '\
      <select name="' + name + '_1"> \
        <option value="-1">-</option> \
        <option value="A">A</option> \
        <option value="B">B</option> \
        <option value="C">C</option> \
      </select> \
      <select name="' + name + '_2" style="display:none;"></select>';
                },
                valueGetter: function (rule) {
                    return rule.$el.find('.rule-value-container [name$=_1]').val()
                        + '.' + rule.$el.find('.rule-value-container [name$=_2]').val();
                },
                valueSetter: function (rule, value) {
                    if (rule.operator.nb_inputs > 0) {
                        var val = value.split('.');

                        rule.$el.find('.rule-value-container [name$=_1]').val(val[0]).trigger('change');
                        rule.$el.find('.rule-value-container [name$=_2]').val(val[1]).trigger('change');
                    }
                }
            }],

            rules: rules_widgets
        });


        $('#btn-reset').on('click', function () {
            $('#builder-widgets').queryBuilder('reset');
        });

        $('#btn-set').on('click', function () {
            $('#builder-widgets').queryBuilder('setRules', rules_widgets);
        });

        $('#btn-get').on('click', function () {
            var result = $('#builder-widgets').queryBuilder('getRules');

            if (!$.isEmptyObject(result)) {
                alert(JSON.stringify(result, null, 2));
            }
        });


        $('#builder1').queryBuilder({
            plugins: ['bt-tooltip-errors'],

            filters: [{
                id: 'date',
                label: 'Datepicker',
                type: 'date',
                validation: {
                    format: 'YYYY/MM/DD'
                },
                plugin: 'datepicker',
                plugin_config: {
                    format: 'yyyy/mm/dd',
                    todayBtn: 'linked',
                    todayHighlight: true,
                    autoclose: true
                }
            }, {
                id: 'rate',
                label: 'Slider',
                type: 'integer',
                validation: {
                    min: 0,
                    max: 100
                },
                plugin: 'slider',
                plugin_config: {
                    min: 0,
                    max: 100,
                    value: 0
                },
                valueSetter: function (rule, value) {
                    if (rule.operator.nb_inputs == 1) value = [value];
                    rule.$el.find('.rule-value-container input').each(function (i) {
                        $(this).slider('setValue', value[i] || 0);
                    });
                },
                valueGetter: function (rule) {
                    var value = [];
                    rule.$el.find('.rule-value-container input').each(function () {
                        value.push($(this).slider('getValue'));
                    });
                    return rule.operator.nb_inputs == 1 ? value[0] : value;
                }
            }, {
                id: 'category',
                label: 'Selectize',
                type: 'string',
                plugin: 'selectize',
                plugin_config: {
                    valueField: 'id',
                    labelField: 'name',
                    searchField: 'name',
                    sortField: 'name',
                    create: true,
                    maxItems: 1,
                    plugins: ['remove_button'],
                    onInitialize: function () {
                        var that = this;

                        if (localStorage.demoData === undefined) {
                            $.getJSON(baseurl + '/assets/demo-data.json', function (data) {
                                localStorage.demoData = JSON.stringify(data);
                                data.forEach(function (item) {
                                    that.addOption(item);
                                });
                            });
                        }
                        else {
                            JSON.parse(localStorage.demoData).forEach(function (item) {
                                that.addOption(item);
                            });
                        }
                    }
                },
                valueSetter: function (rule, value) {
                    rule.$el.find('.rule-value-container input')[0].selectize.setValue(value);
                }
            }, {
                id: 'coord',
                label: 'Coordinates',
                type: 'string',
                validation: {
                    format: /^[A-C]{1}.[1-6]{1}$/
                },
                input: function (rule, name) {
                    var $container = rule.$el.find('.rule-value-container');

                    $container.on('change', '[name=' + name + '_1]', function () {
                        var h = '';

                        switch ($(this).val()) {
                            case 'A':
                                h = '<option value="-1">-</option> <option value="1">1</option> <option value="2">2</option>';
                                break;
                            case 'B':
                                h = '<option value="-1">-</option> <option value="3">3</option> <option value="4">4</option>';
                                break;
                            case 'C':
                                h = '<option value="-1">-</option> <option value="5">5</option> <option value="6">6</option>';
                                break;
                        }

                        $container.find('[name$=_2]')
                            .html(h).toggle(!!h)
                            .val('-1').trigger('change');
                    });

                    return '\
      <select name="' + name + '_1"> \
        <option value="-1">-</option> \
        <option value="A">A</option> \
        <option value="B">B</option> \
        <option value="C">C</option> \
      </select> \
      <select name="' + name + '_2" style="display:none;"></select>';
                },
                valueGetter: function (rule) {
                    return rule.$el.find('.rule-value-container [name$=_1]').val()
                        + '.' + rule.$el.find('.rule-value-container [name$=_2]').val();
                },
                valueSetter: function (rule, value) {
                    if (rule.operator.nb_inputs > 0) {
                        var val = value.split('.');

                        rule.$el.find('.rule-value-container [name$=_1]').val(val[0]).trigger('change');
                        rule.$el.find('.rule-value-container [name$=_2]').val(val[1]).trigger('change');
                    }
                }
            }],

            rules: rules_widgets
        });


        $('#builder2').queryBuilder({
            plugins: ['bt-tooltip-errors'],

            filters: [{
                id: 'date',
                label: 'Datepicker',
                type: 'date',
                validation: {
                    format: 'YYYY/MM/DD'
                },
                plugin: 'datepicker',
                plugin_config: {
                    format: 'yyyy/mm/dd',
                    todayBtn: 'linked',
                    todayHighlight: true,
                    autoclose: true
                }
            }, {
                id: 'rate',
                label: 'Slider',
                type: 'integer',
                validation: {
                    min: 0,
                    max: 100
                },
                plugin: 'slider',
                plugin_config: {
                    min: 0,
                    max: 100,
                    value: 0
                },
                valueSetter: function (rule, value) {
                    if (rule.operator.nb_inputs == 1) value = [value];
                    rule.$el.find('.rule-value-container input').each(function (i) {
                        $(this).slider('setValue', value[i] || 0);
                    });
                },
                valueGetter: function (rule) {
                    var value = [];
                    rule.$el.find('.rule-value-container input').each(function () {
                        value.push($(this).slider('getValue'));
                    });
                    return rule.operator.nb_inputs == 1 ? value[0] : value;
                }
            }, {
                id: 'category',
                label: 'Selectize',
                type: 'string',
                plugin: 'selectize',
                plugin_config: {
                    valueField: 'id',
                    labelField: 'name',
                    searchField: 'name',
                    sortField: 'name',
                    create: true,
                    maxItems: 1,
                    plugins: ['remove_button'],
                    onInitialize: function () {
                        var that = this;

                        if (localStorage.demoData === undefined) {
                            $.getJSON(baseurl + '/assets/demo-data.json', function (data) {
                                localStorage.demoData = JSON.stringify(data);
                                data.forEach(function (item) {
                                    that.addOption(item);
                                });
                            });
                        }
                        else {
                            JSON.parse(localStorage.demoData).forEach(function (item) {
                                that.addOption(item);
                            });
                        }
                    }
                },
                valueSetter: function (rule, value) {
                    rule.$el.find('.rule-value-container input')[0].selectize.setValue(value);
                }
            }, {
                id: 'coord',
                label: 'Coordinates',
                type: 'string',
                validation: {
                    format: /^[A-C]{1}.[1-6]{1}$/
                },
                input: function (rule, name) {
                    var $container = rule.$el.find('.rule-value-container');

                    $container.on('change', '[name=' + name + '_1]', function () {
                        var h = '';

                        switch ($(this).val()) {
                            case 'A':
                                h = '<option value="-1">-</option> <option value="1">1</option> <option value="2">2</option>';
                                break;
                            case 'B':
                                h = '<option value="-1">-</option> <option value="3">3</option> <option value="4">4</option>';
                                break;
                            case 'C':
                                h = '<option value="-1">-</option> <option value="5">5</option> <option value="6">6</option>';
                                break;
                        }

                        $container.find('[name$=_2]')
                            .html(h).toggle(!!h)
                            .val('-1').trigger('change');
                    });

                    return '\
      <select name="' + name + '_1"> \
        <option value="-1">-</option> \
        <option value="A">A</option> \
        <option value="B">B</option> \
        <option value="C">C</option> \
      </select> \
      <select name="' + name + '_2" style="display:none;"></select>';
                },
                valueGetter: function (rule) {
                    return rule.$el.find('.rule-value-container [name$=_1]').val()
                        + '.' + rule.$el.find('.rule-value-container [name$=_2]').val();
                },
                valueSetter: function (rule, value) {
                    if (rule.operator.nb_inputs > 0) {
                        var val = value.split('.');

                        rule.$el.find('.rule-value-container [name$=_1]').val(val[0]).trigger('change');
                        rule.$el.find('.rule-value-container [name$=_2]').val(val[1]).trigger('change');
                    }
                }
            }],

            rules: rules_widgets
        });

    </script>


{% endblock %}



